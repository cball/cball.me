<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge" http-equiv="X-UA-Compatible" /><title>Integrating with Github - Authentication and Web Hooks</title><meta content="width=device-width, initial-scale=1" name="viewport" /><meta content="Level up your development and consulting skills | Chris Ball" name="og:site_name" /><meta content="blog" name="og:type" /><meta content="Just over two weeks ago, I (and hopefully you!) started a challenge to "Just build it". We set a timeline of two weeks to see what we could build in order to level up our development skills. I want to go over what I built, what I've learned, and give..." name="description" /><meta content="http://cball.me" name="og:image" /><meta content="Integrating with Github - Authentication and Web Hooks" name="og:title" /><meta content="http://cball.me/building-a-github-integrated-service/" name="og:url" /><link href="https://plus.google.com/106669872405859111179" rel="author" /><!--[if lt IE 9]><script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script><script src="//oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script><![endif]--><link href="//cloud.typography.com/6222872/746702/css/fonts.css" media="all" rel="stylesheet" type="text/css" /><link href="/stylesheets/application.css" media="all" rel="stylesheet" type="text/css" /></head><body class="building-a-github-integrated-service building-a-github-integrated-service_index"><header><div class="row"><div class="col-xs-12 col-md-2" id="my-picture"><a href="/"><img class="img-circle" width="100" height="100" src="https://1.gravatar.com/avatar/d3cc1542f7fb242f0e73fd70810c0ac5?r=x&s=100" /><span class="name">Chris Ball</span></a></div><div class="col-md-8 col-md-offset-0 col-sm-10 col-sm-offset-1"><ul class="nav nav-pills nav-justified"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/newsletter">Newsletter</a></li><li><a href="/topics/development/">Development</a></li><li><a href="/topics/consulting/">Consulting</a></li><li><a href="/contact">Contact</a></li></ul></div><div class="col-md-2"></div></div></header><div class="container"><div class="row"><div class="col-md-10 col-md-offset-1" id="main"><article><div class="post-header"><div class="inner no-image"><h2>Integrating with Github - Authentication and Web Hooks</h2><div class="date"><div class="month">Jan</div><div class="day">14</div><div class="year">2014</div></div></div></div><div class="post-body"><h2 class="title"><a href="/building-a-github-integrated-service/">Integrating with Github - Authentication and Web Hooks</a></h2><div class="date subtitle">January 14, 2014</div><hr />
<p>Just over two weeks ago, I (and hopefully you!) started a challenge to "<a href="http://cball.me/just-build-it-a-two-week-challenge/">Just build it</a>". We set a timeline of two weeks to see what we could build in order to level up our development skills. I want to go over what I built, what I've learned, and give you tips you can implement in your applications.</p>

<p>The application I built is called Gitshot, and it gives developers and designers the ability to generate screenshots from Github pull requests. So that I don't overload your brain or mine, this is a first in a series of 6 posts. Here's what we'll cover:</p>

<ol>
  <li><strong>Integrating with Github - Authentication and Web Hooks</strong></li>
  <li>Launching a Virtual Machine - Buddy up with Vagrant</li>
  <li>Integrating Further with Github - SSH Keys and Deploy Keys</li>
  <li>Booting your App in the Background</li>
  <li>Generating Screenshots with PhantomJS</li>
  <li>Tying it all together - Look mom, I learned something!</li>
</ol>

<h3 id="github-authentication">Github Authentication</h3>

<h4 id="getting-started">Getting started</h4>
<p>Github uses OAuth for authentication. Instead of having a single token for your application like you would for something like NewRelic, your application will request authorization, store a token, and make requests on behalf of a user.</p>

<p>Start by <a href="https://github.com/settings/applications/new">registering a new application</a>. Callback urls in this section do not have to be publicly accessible. Here are my settings:
<img alt="New Github Application Settings" src="https://s3.amazonaws.com/cball.me/new-github-app.png" /></p>

<p>Add <a href="https://github.com/octokit/octokit.rb">octokit.rb</a> to your Gemfile to interface with the Github API.</p>

<pre class="highlight ruby"><span class="n">gem</span> <span class="s2">&quot;octokit&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.0&quot;</span>
</pre>
<p>Add the following environment variables to your application with the keys from the previous step:</p>

<pre class="highlight ruby"><span class="no">OCTOKIT_CLIENT_ID</span><span class="o">=</span><span class="n">xxxxx</span>
<span class="no">OCTOKIT_SECRET</span><span class="o">=</span><span class="n">xxx</span>
</pre>
<h4 id="show-a-github-link-on-your-loginaccount-page">Show a Github link on your login/account page</h4>
<p>We'll use Octokit to generate the authorization link for us. This link will tell Github what the client application is as well as the scopes to apply to the user permissions.</p>

<pre class="highlight erb"><span class="cp">&lt;%</span> <span class="n">authorize_url</span> <span class="o">=</span> <span class="no">Octokit</span><span class="nf">.authorize_url</span><span class="p">(</span><span class="ss">scope: </span><span class="s2">&quot;repo,user:email&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span><span class="p">(</span><span class="s2">&quot;Connect to Github&quot;</span><span class="p">,</span> <span class="n">authorize_url</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre>
<h4 id="exchange-an-authorization-code-for-a-proper-access-token">Exchange an authorization code for a proper access token</h4>
<p>After the user authorizes our application, Github will hit our callback url defined in the settings and pass a single parameter: <strong>code</strong>. Let's exchange this for a proper OAuth token, which we'll store to make future calls on behalf of the user.</p>

<pre class="highlight ruby"><span class="k">class </span><span class="nc">GithubAuthCallbacksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def </span><span class="nf">oauth_code</span>
    <span class="k">if</span> <span class="n">user_from_github_access_token</span><span class="nf">.update_from_github_info!</span>
      <span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Github does not want us to work together.&#39;</span>
    <span class="k">end</span>
    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def </span><span class="nf">user_from_github_access_token</span>
    <span class="no">User</span><span class="nf">.where</span><span class="p">(</span><span class="ss">github_token: </span><span class="n">github_access_token</span><span class="p">)</span><span class="nf">.first_or_initialize</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">github_access_token</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Client</span><span class="nf">.new</span>
    <span class="n">token_response</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.exchange_code_for_access_token</span> <span class="n">code_params</span><span class="o">[</span><span class="ss">:code</span><span class="o">]</span>
    <span class="n">token_response</span><span class="o">[</span><span class="s1">&#39;access_token&#39;</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">code_params</span>
    <span class="n">params</span><span class="nf">.permit</span><span class="p">(</span><span class="ss">:code</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<p>The magic method here is:</p>

<pre class="highlight ruby"><span class="n">client</span><span class="nf">.exchange_code_for_access_token</span>
</pre>
<p>It does exactly what it says. Given an authorization code, it will return an access token that you can store permanently (though keep in mind the user can revoke access at any time so you should handle that in your application).</p>

<p>Now that you're authenticated, you should be able to call any method in the api on behalf of the user. For example, to get a list of the user's repositories:</p>

<pre class="highlight ruby"><span class="n">client</span> <span class="o">=</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Client</span><span class="nf">.new</span><span class="p">(</span><span class="ss">access_token: </span><span class="n">user</span><span class="nf">.github_token</span><span class="p">)</span>
<span class="n">client</span><span class="nf">.repos</span>
</pre>
<p>Note however, this does not include Organization repositories that the user has access to. Here's how I get these on Gitshot:</p>

<pre class="highlight ruby"><span class="k">class </span><span class="nc">GithubRepositoryFetcher</span>
  <span class="kp">attr_accessor</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:client</span>

  <span class="k">def </span><span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="vi">@client</span> <span class="o">=</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Client</span><span class="nf">.new</span><span class="p">(</span><span class="ss">access_token: </span><span class="n">user</span><span class="nf">.github_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">all</span>
    <span class="n">user_repositories</span> <span class="o">+</span> <span class="n">organization_repositories</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">user_repositories</span>
    <span class="n">client</span><span class="nf">.repos</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">organization_repositories</span>
    <span class="n">organization_names</span><span class="nf">.map</span> <span class="p">{</span><span class="o">|</span><span class="n">o</span><span class="o">|</span> <span class="n">client</span><span class="nf">.organization_repositories</span> <span class="n">o</span> <span class="p">}</span><span class="nf">.flatten</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def </span><span class="nf">organization_names</span>
    <span class="n">client</span><span class="nf">.organizations.map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:login</span><span class="p">)</span>
  <span class="k">end</span>
</pre>
<p><em>I'm sure there is a more efficient way to do thisâ€¦ I don't love the fact that this makes n+1 organization repository calls just to get a list of all repositories the user has access to.</em></p>

<h3 id="github-web-hooks">Github Web Hooks</h3>

<p>In order to know when to generate screenshots and to be able to gather information from a Github pull request, we need to install a web hook. A web hook at its core is <strong>just another callback url</strong>, that Github will post as much information as it possibly can about a pull request, comment or other activity. Here's how we do that:</p>

<pre class="highlight ruby"><span class="k">class </span><span class="nc">ProjectGitHookAdder</span>
  <span class="kp">attr_accessor</span> <span class="ss">:project</span>
  <span class="n">delegate</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">to: :project</span>

  <span class="k">def </span><span class="nf">initialize</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="vi">@project</span> <span class="o">=</span> <span class="n">project</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">add</span>
    <span class="n">client</span> <span class="o">=</span> <span class="no">Octokit</span><span class="o">::</span><span class="no">Client</span><span class="nf">.new</span> <span class="ss">access_token: </span><span class="n">user</span><span class="nf">.github_token</span>
    <span class="n">hook</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.create_hook</span><span class="p">(</span>
      <span class="n">project</span><span class="nf">.repository</span><span class="p">,</span>
      <span class="s1">&#39;web&#39;</span><span class="p">,</span>
      <span class="n">hook_url_config</span><span class="p">,</span>
      <span class="n">hook_options</span>
    <span class="p">)</span>

    <span class="n">hook</span><span class="nf">.id.present?</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def </span><span class="nf">hook_url_config</span>
    <span class="p">{</span>
      <span class="ss">url: </span><span class="s1">&#39;http://gitshot.24.183.111.227.xip.io/hooks/1&#39;</span><span class="p">,</span>
      <span class="ss">content_type: </span><span class="s1">&#39;json&#39;</span>
    <span class="p">}</span>
   <span class="k">end</span>

  <span class="k">def </span><span class="nf">hook_options</span>
    <span class="p">{</span>
      <span class="ss">events: </span><span class="o">[</span><span class="s1">&#39;pull_request&#39;</span><span class="p">,</span> <span class="s1">&#39;pull_request_review_comment&#39;</span><span class="p">,</span> <span class="s1">&#39;commit_comment&#39;</span><span class="p">,</span> <span class="s1">&#39;issue_comment&#39;</span><span class="o">]</span><span class="p">,</span>
      <span class="ss">active: </span><span class="kp">true</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<p>The important parts of the hook parameters are:</p>

<ul>
  <li><strong>repository name</strong> in the form of &lt;user/repo&gt; (cball/something).</li>
  <li><strong>the url</strong> (when developing locally I like to use xip.io since it integrates nicely with pow). Keep in mind that this url <em>must be publicly accessible</em>.</li>
  <li><strong>events</strong> all of the events that will trigger this hook</li>
  <li><strong>active</strong> you'll want active to be true, so something actually happens</li>
</ul>

<p>Github has great documentation on the event types in case you need something different.</p>

<h4 id="testing-it-out">Testing it out</h4>
<p>After authenticating and adding a hook to a repository, you should be able to see your new hook installed in the repository settings.</p>

<p>Note: If you find yourself needing to add additional event types, the only way to do so is through the API. </p>

<h4 id="parsing-incoming-hooks">Parsing incoming hooks</h4>

<p>The json payload is slightly different for each event you have registered, but a lot of the information is the same. </p>

<p>For Gitshot, I decided on a message convention of [screenshot /myurl]. This required scanning incoming hook data for this string in order to derive the URL the user wanted to fetch. If this message appears in the payload, we need to try and grab the HEAD and BASE commit hashes, as well as the open/closed state. If the message is not found, or the pull request is closed, we ignore it. Here's how that works in Gitshot:</p>

<pre class="highlight ruby"><span class="c1"># code</span>
</pre>
<p>Awesome! We've done a lot here. We started working with the Github API, authorized our application using OAuth, and installed a hook to let Github notify us when there is activity on the repository we care about. </p>

<p>In part 2, we will be delving into virtual machines using Vagrant. This is extremely important in order to be able to check out and run code from our authorized repository in an secure, isolated, and temporary environment. Talk to you then! <a href="http://cball.me/newsletter">Get email updates for the rest of the series here</a>.</p>
<ul class="nav tags nav-pills"><li><a href="/topics/development/">/<span class="name">development</span>/</a></li></ul><div class="row"><div class="col-md-8 col-md-offset-2" id="upsell"><h3>Learned something new?</h3><p>Get my best development and consulting advice every week, right in your inbox.</p><a class="btn btn-warning" href="/newsletter/">Join for free</a></div></div><div id="article-nav"><div class="pull-left"><a href="/how-to-grow-your-consulting-business-in-only-4-hours-per-week/">&laquo; How to Grow your Consulting...</a></div><div class="pull-right"></div></div></div><div id="comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'cballme'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>

  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</article></div></div><div class="row"><div class="col-md-12"><div class="echobind center"><a target="_blank" href="http://echobind.com"><img src="/images/echobind.png" /></a><p>Founder / Principal</p></div></div></div></div><footer><ul class="list-unstyled"><li><a href="/newsletter">Free updates</a></li><li class="separator">&mdash;</li><li><a href="/contact">Contact</a></li><li class="separator">&mdash;</li><li><a href="/about">Built by Chris</a></li></ul></footer><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script src="/javascripts/application.js" type="text/javascript"></script><script type="text/javascript">// gauges
var _gauges = _gauges || [];
(function() {
  var t   = document.createElement('script');
  t.type  = 'text/javascript';
  t.async = true;
  t.id    = 'gauges-tracker';
  t.setAttribute('data-site-id', '5283075d108d7b40cf0000b8');
  t.src = '//secure.gaug.es/track.js';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(t, s);
})();

// GA
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-46757526-1', 'cball.me');
ga('send', 'pageview');</script></body></html>